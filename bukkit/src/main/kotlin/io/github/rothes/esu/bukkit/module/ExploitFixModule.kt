package io.github.rothes.esu.bukkit.module

import io.github.rothes.esu.bukkit.plugin
import io.github.rothes.esu.core.module.configuration.BaseModuleConfiguration
import io.github.rothes.esu.core.module.configuration.EmptyConfiguration
import org.bukkit.Bukkit
import org.bukkit.Material
import org.bukkit.event.EventHandler
import org.bukkit.event.HandlerList
import org.bukkit.event.Listener
import org.bukkit.event.inventory.InventoryClickEvent
import org.spongepowered.configurate.objectmapping.meta.Comment

object ExploitFixModule: BukkitModule<ExploitFixModule.ModuleConfig, EmptyConfiguration>(
    ModuleConfig::class.java, EmptyConfiguration::class.java
) {

    override fun enable() {
        Bukkit.getPluginManager().registerEvents(Listeners, plugin)
    }

    @Suppress("DEPRECATION")
    override fun disable() {
        super.disable()
        HandlerList.unregisterAll(Listeners)
    }

    private object Listeners: Listener {
        @EventHandler
        fun onInvClick(e: InventoryClickEvent) {
            val config = config
            if (!config.blockInventoryClickWhileUsingItems)
                return
            val player = e.viewers.firstOrNull() ?: return
            if (player.isHandRaised) {
                if (config.onlyBlockConsumerItems) {
                    if (e.hotbarButton == -1) return

                    val item = player.inventory.getItem(e.hotbarButton) ?: return
                    val type = item.type
                    if (type != Material.BOW && type != Material.TRIDENT)
                        return
                }
                e.isCancelled = true
            }
        }
    }

    data class ModuleConfig(
        @field:Comment("Blocking moving or clicking items in inventory while player is using item.\n" +
                "This is for fixing trident/bow duplication exploit.\n" +
                "If you are running Paper 1.21.4+, this is already fixed, and you don't need this.")
        val blockInventoryClickWhileUsingItems: Boolean = true,
        @field:Comment("More detailed detect to block trident/bow duplication only.\n" +
                "If you allow more cheats, enable this.")
        val onlyBlockConsumerItems: Boolean = false,
    ): BaseModuleConfiguration()

}